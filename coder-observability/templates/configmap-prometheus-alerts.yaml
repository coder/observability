apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-alerts
data:
  {{ with .Values.global.postgres }}
  postgres.yaml: |-
  {{- with .alerts.groups.Notifications }}
  {{- $group := . -}}
  {{- if .enabled }}
    groups:
    - name: Notifications
      rules:
      {{- range $severity, $threshold := .thresholds }}
      - alert: PostgresNotificationQueueFillingUp
        expr: {{ include "postgres-pubsub-queue-usage-metric-name" . }} > {{ $threshold }}
        for: {{ $group.delay }}
        labels:
          severity: {{ $severity }}
      {{- end }}
  {{- end -}}
  {{- end -}}
  {{- with .alerts.groups.Basic }}
  {{ $group := . -}}
  {{- if .enabled }}
    groups:
    - name: Basic
      rules:
      - alert: PostgresDown
        expr: pg_up == 0
        for: {{ $group.delay }}
        labels:
          severity: critical
      {{- end }}
  {{ end }}
  {{ end }}