apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-alerts
  namespace: {{ .Release.Namespace }}
data:
  {{- $service := dict "service" "coder" -}}

  {{- with .Values.global.coder.coderd }}
  coder.yaml: |-
    groups:
  {{- with .alerts.groups.CPU }}
  {{- $group := . }}
  {{- if .enabled }}
    - name: CPU Usage
      rules:
      {{ $alert := "CoderdCPUUsage" }}
      {{- range $severity, $threshold := .thresholds }}
      - alert: {{ $alert }}
        expr: max by (pod) (rate(container_cpu_usage_seconds_total{ {{- include "coderd-selector" $ -}} }[{{- $group.period -}}])) / max by(pod) (kube_pod_container_resource_limits{ {{- include "coderd-selector" $ -}}, resource="cpu"}) > {{ $threshold }}
        for: {{ $group.delay }}
        labels:
          summary: The Coder instance {{ `{{ $labels.pod }}` }} is using high amounts of CPU, which may impact application performance.
          severity: {{ $severity }}
          runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{- end }}
  {{- end }}

  {{- with .alerts.groups.Memory }}
  {{- $group := . }}
  {{- if .enabled }}
    - name: Memory Usage
      rules:
      {{ $alert := "CoderdMemoryUsage" }}
      {{- range $severity, $threshold := .thresholds }}
      - alert: {{ $alert }}
        expr: max by (pod) (container_memory_working_set_bytes{ {{- include "coderd-selector" $ -}} }) / max by (pod) (kube_pod_container_resource_limits{ {{- include "coderd-selector" $ -}}, resource="memory"})  > {{ $threshold }}
        for: {{ $group.delay }}
        labels:
          summary: The Coder instance {{ `{{ $labels.pod }}` }} is using high amounts of memory, which may lead to an Out-Of-Memory (OOM) error.
          severity: {{ $severity }}
          runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{- end }}
  {{- end }}

  {{- with .alerts.groups.Restarts }}
  {{- $group := . }}
  {{- if .enabled }}
    - name: Pod Restarts
      rules:
      {{ $alert := "CoderdRestarts" }}
      {{- range $severity, $threshold := .thresholds }}
      - alert: {{ $alert }}
        expr: sum by(pod) (increase(kube_pod_container_status_restarts_total{ {{- include "coderd-selector" $ -}} }[{{- $group.period -}}])) > {{ $threshold }}
        for: {{ $group.delay }}
        labels:
          summary: The Coder instance {{ `{{ $labels.pod }}` }} has restarted multiple times in the last {{ $group.period -}}, which may indicate a CrashLoop.
          severity: {{ $severity }}
          runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- $service = dict "service" "postgres" -}}
  {{- with .Values.global.postgres }}
  postgres.yaml: |-
    groups:
  {{- with .alerts.groups.Notifications }}
  {{- $group := . -}}
  {{- if .enabled }}
    - name: Notifications
      rules:
      {{ $alert := "PostgresNotificationQueueFillingUp" }}
      {{- range $severity, $threshold := .thresholds }}
      - alert: {{ $alert }}
        expr: {{ include "postgres-pubsub-queue-usage-metric-name" . }} > {{ $threshold }}
        for: {{ $group.delay }}
        labels:
          summary: The postgres instance {{ `{{ $labels.instance }}` }} has a notification that is filling up, which may impact application performance.
          severity: {{ $severity }}
          runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{- end -}}
  {{- end -}}
  {{- with .alerts.groups.Basic }}
  {{ $group := . -}}
  {{- if .enabled }}
    - name: Liveness
      rules:
      {{ $alert := "PostgresDown" }}
      - alert: {{ $alert }}
        expr: pg_up == 0
        for: {{ $group.delay }}
        labels:
          summary: The postgres instance {{ `{{ $labels.instance }}` }} is down!
          severity: critical
          runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{ end }}
  {{- with .alerts.groups.Connections }}
  {{ $group := . -}}
  {{- if .enabled }}
    - name: Connections
      rules:
      {{ $alert := "PostgresConnectionsRunningLow" }}
      {{- range $severity, $threshold := .thresholds }}
        - alert: {{ $alert }}
          expr: sum by (datname, instance) (pg_stat_activity_count) > on () group_left() (pg_settings_max_connections * {{ $threshold }})
          for: {{ $group.delay }}
          labels:
            summary: The postgres instance {{ `{{ $labels.instance }}` }} is running low on connections which may impact application performance.
            severity: {{ $severity }}
            runbook_url: {{ template "runbook-url" (deepCopy $ | merge (dict "alert" $alert) $service) }}
      {{- end }}
  {{- end -}}
  {{- end -}}
  {{ end }}
